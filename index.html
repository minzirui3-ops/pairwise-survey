<script>
document.addEventListener('DOMContentLoaded', function () {
  // === 常量 ===
  var MANIFEST_URL = 'https://minzirui3-ops.github.io/pairwise-survey/manifest.json';
  var ALIYUN_ENDPOINT = 'https://daili-jogcnerjku.cn-hangzhou.fcapp.run/submit';

  // === 元素 ===
  function $(s){ return document.querySelector(s); }
  var who = $('#who'), sess = $('#sess'), prog = $('#prog'), bar = $('#bar');
  var imgA = $('#imgA'), imgB = $('#imgB'), pairInfo = $('#pairInfo');

  // === 参与者/会话 ===
  var qs = new URLSearchParams(location.search);
  var allowTie = qs.get('allowTie') !== '0';
  var minK = parseInt(qs.get('k') || '5', 10);
  var respondent = (qs.get('rid') || '').trim();
  var sessionId = String(Date.now());
  if (who)  who.textContent  = respondent || 'anonymous';
  if (sess) sess.textContent = sessionId;

  // === 状态 ===
  var images = [];   // 全部图片 URL
  var names  = [];   // 文件名
  var counts = {};   // name -> 次数
  var pairSeen = {}; // 'a__b' -> true
  var plan = [];     // [{a,b}]
  var idx = 0;       // 当前指针
  var cur = null;    // 当前 pair

  // === 事件 ===
  var btnA = $('#voteA'), btnB = $('#voteB'), btnT = $('#voteTie'), btnS = $('#voteSkip');
  if (btnA) btnA.onclick = function(){ vote(1); };
  if (btnB) btnB.onclick = function(){ vote(-1); };
  if (btnT) btnT.onclick = function(){ if (allowTie) vote(0); };
  if (btnS) btnS.onclick = function(){ vote('skip'); };
  document.addEventListener('keydown', function(e){
    if (e.key === 'a' || e.key === 'A') vote(1);
    if (e.key === 'l' || e.key === 'L') vote(-1);
    if (e.key === 'e' || e.key === 'E') { if (allowTie) vote(0); }
    if (e.key === 's' || e.key === 'S') vote('skip');
  });

  // === 加载清单 ===
  fetch(MANIFEST_URL).then(function(r){return r.json();}).then(function(list){
    images = list.filter(function(u){ return typeof u === 'string'; });
    names  = images.map(function(u){ return u.split('/').pop(); });
    names.forEach(function(n){ counts[n] = 0; });
    buildPlan();
    render();
  }).catch(function(err){
    console.error(err);
    if (pairInfo) pairInfo.textContent = '加载清单失败';
  });

  function pairKey(a,b){
    return [a,b].sort().join('__');
  }

  function needPairsLeft(){
    var shortage = names.reduce(function(acc, n){
      var c = counts[n] || 0;
      var lack = Math.max(0, minK - c);
      return acc + lack;
    }, 0);
    return Math.ceil(shortage / 2);
  }

  function buildPlan(){
    plan = [];
    var cnt = {};
    names.forEach(function(n){ cnt[n] = counts[n] || 0; });
    var need = names.filter(function(n){ return (cnt[n] || 0) < minK; });

    // 简化匹配逻辑：按需要度贪心配对
    while (need.length > 0) {
      need.sort(function(a,b){ return (cnt[a]||0) - (cnt[b]||0); });
      var x = need[0];
      var candidates = names.slice().sort(function(a,b){ return (cnt[a]||0) - (cnt[b]||0); });

      var paired = false;
      for (var i=0;i<candidates.length;i++){
        var y = candidates[i];
        if (y === x) continue;
        var key = pairKey(x,y);
        if (pairSeen[key]) continue;
        plan.push({a:x,b:y});
        pairSeen[key] = true;
        cnt[x] = (cnt[x]||0) + 1;
        cnt[y] = (cnt[y]||0) + 1;
        paired = true;
        break;
      }
      if (!paired) break;

      need = names.filter(function(n){ return (cnt[n] || 0) < minK; });
    }

    // 打乱
    for (var j=plan.length-1;j>0;j--){
      var k = Math.floor(Math.random()*(j+1));
      var tmp = plan[j]; plan[j] = plan[k]; plan[k] = tmp;
    }
    idx = 0;
  }

  function render(){
    if (idx >= plan.length){
      var left = needPairsLeft();
      if (prog) prog.textContent = plan.length + ' / ' + plan.length;
      if (bar)  bar.style.width  = '100%';
      if (pairInfo) pairInfo.textContent = left > 0
        ? '本轮已完成。剩余理论最少配对约 ' + left + ' 组（基于K=' + minK + '）。'
        : '本轮已完成，感谢参与！';
      if (imgA) imgA.removeAttribute('src');
      if (imgB) imgB.removeAttribute('src');
      return;
    }

    cur = plan[idx];
    var urlA = images[names.indexOf(cur.a)];
    var urlB = images[names.indexOf(cur.b)];
    if (imgA) imgA.src = urlA;
    if (imgB) imgB.src = urlB;

    if (pairInfo) pairInfo.textContent = '第 ' + (idx+1) + '/' + plan.length + ' 组｜A: ' + cur.a + ' ｜ B: ' + cur.b;
    if (prog) prog.textContent = idx + '/' + plan.length;
    if (bar)  bar.style.width  = ((idx / plan.length) * 100) + '%';

    // 预取下一组
    var next = plan[idx+1];
    if (next){
      var preA = new Image(), preB = new Image();
      preA.decoding = 'async'; preB.decoding = 'async';
      preA.loading  = 'eager'; preB.loading  = 'eager';
      preA.src = images[names.indexOf(next.a)];
      preB.src = images[names.indexOf(next.b)];
    }
  }

  function vote(choice){
    if (idx >= plan.length) return;
    if (choice !== 'skip'){
      counts[cur.a] = (counts[cur.a] || 0) + 1;
      counts[cur.b] = (counts[cur.b] || 0) + 1;
    }
    var payload = {
      timestamp: new Date().toISOString(),
      respondent_id: respondent || 'anonymous',
      round_idx: idx + 1,
      image_a: cur.a,
      image_b: cur.b,
      choice: choice,
      pair_id: pairKey(cur.a, cur.b),
      session_id: sessionId
    };
    fetch(ALIYUN_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload),
      keepalive: true
    }).catch(function(){});

    idx++; render();
  }
});
</script>
